name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name. eg) "v0.1.0"'
        required: true
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

env:
  DOTNET_VERSION: 8.0.x
  TAG_NAME: ${{ inputs.tag || github.ref_name }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: ðŸ’¡ gh --version
        run: gh --version
      - name: ðŸ§ª gh auth status
        run: gh auth status
      - name: ðŸ›’ Checkout
        uses: actions/checkout@v4.2.1
      - name: âœ¨ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: ðŸ› ï¸ Build
        run: dotnet build --configuration Release

      - name: ðŸš€ Publish
        run: |
          $timestamp = "${{ env.TAG_NAME }}"

          dotnet publish --configuration Release -p:PublishProfile=FolderProfile --output ".\artifacts\SqlConnectionTester" ".\src\SqlConnectionTester\SqlConnectionTester.csproj"
          $zipFileName1 = ".\SqlConnectionTester-win-x64_" + $timestamp + ".zip"
          Compress-Archive -DestinationPath $zipFileName1 -Path ".\artifacts\SqlConnectionTester"
          Remove-Item -Recurse -Force artifacts

      - name: ðŸ“ Create Draft Release
        run: gh release create ${{ env.TAG_NAME }} --title "Release ${{ env.TAG_NAME }}" --generate-notes --draft --prerelease

      - name: âž• Upload Assets
        run: gh release upload ${{ env.TAG_NAME }} $(ls ".\*_${{ env.TAG_NAME }}.zip")

      - name: ðŸ“£ Summary
        run: echo "### âœ… Release succeeded! ${{ env.TAG_NAME }} ðŸŒŸ" >> $GITHUB_STEP_SUMMARY
        shell: bash
